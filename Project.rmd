---
title: "Project"
author: "Shingyan Kwong, Roman Stepchyn, Gerald Mathias, Scarlett Groom-Ransom, Oliver Lountain"
date: "October 15, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(readxl)
library(broom)
gumtree <- read_excel("Gumtree_dogs.xlsx")
```




# Cleaning Data

### Price

```{r}
table(gumtree$price)
gumtree$price[gumtree$price == "NA"] <- NA
table(gumtree$price)

```
Change all "NA" values to a value of NA understood by R. 

```{r}
summary(gumtree$price)
```
This looks strange.Lets see what class price is. 

```{r}
class(gumtree$price)

```
Price is a character. We need to convert this to a numeric variable. 

```{r}
gumtree$price <- as.numeric(gumtree$price)

```

Checking plot of price to pass stupidity test:
  
```{r}
ggplot(gumtree, aes(price)) +
  geom_histogram(col = "black", fill = "Light Blue")
```


The prices displayed in the histogram seem reasonable, as dogs can be very expensive, perhaps up to $10000, but the majority are in the more affordable range.

To be sure, we check the summary statistics:
```{r}
summary(gumtree$price)
```

The prices seem reasonable. 


### Cross


```{r}
table(gumtree$cross)
gumtree$cross[gumtree$cross == "NA"] <- NA
table(gumtree$cross)
class(gumtree$cross)
gumtree$cross <- as.factor(gumtree$cross)

```
The data seems reasonable. 

### Pet offered by

```{r}
table(gumtree$`Pet Offered By:`)
gumtree$`Pet Offered By:`[gumtree$`Pet Offered By:` == "NA"] <- NA
table(gumtree$`Pet Offered By:`)
class(gumtree$`Pet Offered By:`)
gumtree$`Pet Offered By:` <- as.factor(gumtree$`Pet Offered By:`)
summary(gumtree$`Pet Offered By:`)
```
No apparent anomalies in the data.  


### Microchipped

```{r}
table(gumtree$micro)
gumtree$micro[gumtree$micro == "NA"] <- NA
table(gumtree$micro)
class(gumtree$micro)
gumtree$micro <- as.factor(gumtree$micro)
summary(gumtree$micro)
```
Data looks fine. 


### Vaccinated


```{r}
table(gumtree$vacc)
gumtree$vacc[gumtree$vacc == "NA"] <- NA
class(gumtree$vacc)
```
Let's change this to a categorical variable. 
```{r}
gumtree$vacc<-as.factor(gumtree$vacc)
table(gumtree$vacc)
```

### Desexing Status


```{r}
table(gumtree$desex)
gumtree$desex[gumtree$desex == "NA"] <- NA
class(gumtree$desex)
```
Let's change it to categorical. 

```{r}
gumtree$desex<-as.factor(gumtree$desex)
table(gumtree$desex)
```




### Relinquished


```{r}
table(gumtree$relinquished)
gumtree$relinquished[gumtree$relinquished == "NA"] <- NA
class(gumtree$relinquished)
gumtree$relinquished <- as.factor(gumtree$relinquished)
table(gumtree$relinquished)
```
Data looks fine. 

### Age


```{r, eval = FALSE}
table(gumtree$age)
gumtree$age[gumtree$age == "NA"] <- NA
class(gumtree$age)
gumtree$relinquished <- as.factor(gumtree$relinquished)
table(gumtree$age)
```

Checking plot of age to pass stupidity test:
  
  
```{r}
ggplot(gumtree, aes(age)) +
  geom_histogram(col = "black", fill = "Light Blue")
```

#This doesn't look right, check summary:

summary(gumtree$age)

This doesn't look right, check summary:

```{r}
summary(gumtree$age)
```

How bizzare, at least on dog is less than 0 years old, and at least one is 545.8 years old. Lets filter out those in unreasonable age ranges.

```{r}
gumtree %>%
  filter(age>25) %>%
  select(age)
```

```{r}
gumtree %>%
  filter(age<0) %>%
  select(age)
```

Since we have the go ahead from the researcher that these values are wrong, we will remove them from the dataset:

```{r}
gumtree <- gumtree %>%
  filter(age>0, age<26)
```

Now we will check the summary again:
```{r}
summary(gumtree$age)
```

These are much more reasonable values.




# Bivariate Analysis

### Pet Offered By

Here we produce a boxplot for pets offered by owners and those offered by breeders against the response variable price:

```{r, warning = F, error = F, fig.cap = "Figure 1: Boxplots of dog prices on Gumtree sorted by seller"}
ggplot(gumtree, aes(x = `Pet Offered By:`, y = price)) + geom_boxplot()
```

We now produce the same plot but against the natural logarithm of price, since the interquartile range spanned a small portion of the price axis when the outliers are considered.

```{r, warning = F, error = F, fig.cap = "Figure 1.1: Boxplots of the natural logarithm of dog prices on Gumtree sorted by seller"}
ggplot(gumtree, aes(x = `Pet Offered By:`, y = log(price))) + geom_boxplot()
```

#### Description

**Shape:**
Both seem to be symmetrical aside from outliers

**Location:**
The data for dogs sold by breeders is centred at a higher price than those being sold by owners.

**Spread:**
There is a much wider range of prices of dogs sold by breeders than those sold by owners.

**Outliers:**
There are a number of outliers well above the majority of the prices for dogs sold by owners, most likely special breeds, and six outliers sold by breeders.


### Microchip

Here we produce a boxplot for pets offered by owners and those offered by breeders against the response variable price:

```{r, warning = F, error = F, fig.cap = "Figure 2: Boxplots of dog prices on Gumtree sorted by whether dogs have been microchipped"}
ggplot(gumtree, aes(x = micro, y = price)) + geom_boxplot()
```

We can now filter out the NA values:

```{r, warning = F, error = F, fig.cap = "Figure 2.1: Boxplots of dog prices on Gumtree sorted by whether dogs have been microchipped, without NA values"}
ggplot(gumtree %>% filter(!is.na(gumtree$micro)), aes(x = micro, y = price)) + geom_boxplot()
```

Again, we produce the same plot but against the natural logarithm of price, since the interquartile range spanned a small portion of the price axis when the outliers are considered.

```{r, warning = F, error = F, fig.cap = "Figure 2.2: Boxplots of the natural logarithm of dog prices on Gumtree sorted by whether dogs have been microchipped, without NA values"}
ggplot(gumtree %>% filter(!is.na(gumtree$micro)), aes(x = micro, y = log(price))) + geom_boxplot()
```

#### Description

**Shape:**
Dogs which have been microchipped seem to have generally symmetrical data. Those which are not microchipped may be slightly right-skewed.

**Location:**
The data for dogs which have been microchipped is centred at a slightly higher price than those which have not been microchipped, but there is some overlap.

**Spread:**
There is a much wider range of prices of dogs which have been microchipped than which have not been.

**Outliers:**
There is a large number of outliers for the dogs which have been microchiped. There are no outliers for the dogs which have not been microchipped.

### Vaccination

```{r, warning = F, error = F, fig.cap = "Figure 3: Boxplots of the dog prices on Gumtree sorted by whether dogs have been vaccinated"}
ggplot(gumtree, aes(x = vacc, y = price)) + geom_boxplot()
```

Without NA values:

```{r, warning = F, error = F, fig.cap = "Figure 3.1: Boxplots of the dog prices on Gumtree sorted by whether dogs have been vaccinated, without NA values"}
ggplot(gumtree %>% filter(!is.na(gumtree$vacc)), aes(x = vacc, y = price)) + geom_boxplot()
```

Again, we produce the same plot but against the natural logarithm of price, since the interquartile range spanned a small portion of the price axis when the outliers are considered.

```{r, warning = F, error = F, fig.cap = "Figure 3.2: Boxplots of the natural logarithm of dog prices on Gumtree sorted by whether dogs have been vaccinated, without NA values"}
ggplot(gumtree %>% filter(!is.na(gumtree$vacc)), aes(x = vacc, y = log(price))) + geom_boxplot()
```

#### Description

**Shape:**
Both dogs which have and which have not been vaccinated appear to have symmetrical data, however, since those which have not, have such a narrow spread, (possibly due to a small sample size) it is difficult to be certain.

**Location:**
The centre of the data for dogs which have not been vaccinated is at a lower price than those which have.

**Spread:**
Those which have been vaccanited have a reasonably small spread apart from outliers, and those which have not been vaccinated have a very small spread.

**Outliers:**
The non-vaccinated dogs appear to have one outlier either side of the centre, and the dogs which have been vaccinated have a larger number of oultiers at prices much higher than the centre of the data.

### Desexing Status

```{r, warning = F, error = F, fig.cap = "Figure 4: Boxplots of the dog prices on Gumtree sorted by whether dogs have been desexed"}
ggplot(gumtree, aes(x = desex, y = price)) + geom_boxplot()
```

Without NA values:

```{r, warning = F, error = F, fig.cap = "Figure 4.1: Boxplots of the dog prices on Gumtree sorted by whether dogs have been vaccinated, without NA values"}
ggplot(gumtree %>% filter(!is.na(gumtree$desex)), aes(x = desex, y = price)) + geom_boxplot()
```

Again, we produce the same plot but against the natural logarithm of price, since the interquartile range spanned a small portion of the price axis when the outliers are considered.

```{r, warning = F, error = F, fig.cap = "Figure 4.2: Boxplots of the natural logarithm of dog prices on Gumtree sorted by whether dogs have been desexed, without NA values"}
ggplot(gumtree %>% filter(!is.na(gumtree$desex)), aes(x = desex, y = log(price))) + geom_boxplot()
```

#### Description

**Shape:**
The prices of dogs which have been desexed appears to be symmetrically distributed, while the prices of those which are entire appears to be somewhat right-skewed.

**Location:**
The data for the dogs which have not been desexed is centred a slightly higher price than those which have been desexed, but the difference is only approximately $100.

**Spread:**
The range of prices for the entire dogs is significantly larger than that for the desexed gods, which have quite a narrow spread.

**Outliers:**
There are a number of outliers in the prices of dogs which have been desexed, whereas there are only two outliers in the prices of dogs which have not been desexed.


### State

```{r, warning = F, error = F, fig.cap = "Figure 5: Boxplots of the dog prices on Gumtree sorted by state"}
ggplot(gumtree, aes(x = state, y = price)) + geom_boxplot()
```

Without NA values:

```{r, warning = F, error = F, fig.cap = "Figure 5.1: Boxplots of the dog prices on Gumtree sorted by state, without NA values"}
ggplot(gumtree %>% filter(!is.na(gumtree$state)), aes(x = state, y = price)) + geom_boxplot()
```

Again, we produce the same plot but against the natural logarithm of price, since the interquartile range spanned a small portion of the price axis when the outliers are considered.

```{r, warning = F, error = F, fig.cap = "Figure 5.2: Boxplots of the natural logarithm of dog prices on Gumtree sorted by state, without NA values"}
ggplot(gumtree %>% filter(!is.na(gumtree$state)), aes(x = state, y = log(price))) + geom_boxplot()
```

#### Description

**Shape:**
The distribution of prices of dogs seem to be mostly symmetrical in all states, except the prices in Victoria may be slightly right-skewed.

**Location:**
The centre of the data for dogs prices is very similar amongst all states.

**Spread:**
Most states have a smilarly small spread of data, except Victoria which has a wider spread, and ACT and WA which both have narrower spreads.

**Outliers:**
All states appear to have a number of outliers, with the least extreme prices in Tasmania.



### Cross

```{r, warning = F, error = F, fig.cap = "Figure 8: Boxplots of dog prices on Gumtree sorted by cross"}
ggplot(gumtree, aes(x = cross, y = price)) + geom_boxplot()
```

#### Description

**Shape:**
The distribution of prices for dogs which are and are not been cross breeds appear to both be right-skeweed.

**Location:**
The centre of the data for dogs which are not been cross breeds is at a slightly higher price than those which are

**Spread:**
Prices of dogs which have been cross bred have a slightly wider spread of data than those which have not.

**Outliers:**
Both dogs which are cross breeds and those which are not have a large number of more extreme prices which can be considered to be outliers.

### Relinquished

```{r, warning = F, error = F, fig.cap = "Figure 6: Boxplots of the dog prices on Gumtree sorted by whether dogs have been relinquished"}
ggplot(gumtree, aes(x = relinquished, y = price)) + geom_boxplot()
```

Again, we produce the same plot but against the natural logarithm of price, since the interquartile range spanned a small portion of the price axis when the outliers are considered.

```{r, warning = F, error = F, fig.cap = "Figure 7: Boxplots of the natural logarithm of dog prices on Gumtree sorted by relinquished"}
ggplot(gumtree %>% filter(!is.na(gumtree$state)), aes(x = relinquished, y = log(price))) + geom_boxplot()
```

#### Description

**Shape:**
The distribution of prices for dogs which have and have not been relinquished appear to both be approximately symmetrical.

**Location:**
The centre of the data for dogs which have not been relinquished is at a slightly higher price than those which have.

**Spread:**
Both those dogs which have and which have not been relinquished have a similarly narrow spread of prices.

**Outliers:**
Both dogs which have been relinquished and those which have not have a large number of more extreme prices which can be considered to be outliers.

### Age

```{r, warning = F, error = F, fig.cap = "Figure 7: Scatterplot of the dog prices of Gumtree against the age of the dog"}
ggplot(gumtree, aes(x = age, y = price)) + geom_point()
```

#### Description

**Linearity:**
The relationship between age and price does not seem to be at all linear.

**Direction**
The relationship appears to be negative (higher age corresponds to lower prices).

**Strength**
There is a large spread of data, so the strength of the relationship is weak to moderate.


Since the data does not appear at all linear, we can produce the same plot but with the natural logarithm of price:

```{r, warning = F, error = F, fig.cap = "Figure 7: Scatterplot of the natural logarithm of dog prices of Gumtree against the age of the dog"}
ggplot(gumtree, aes(x = age, y = log(price))) + geom_point()
```

# Model Fitting

Modelling against age:

```{r}
age.lm <- lm(price ~ age, data = gumtreeN)
glance(age.lm)
```

The p-value is less than the significance level of 0.05, hence the age data should be considered for the final model.

Modelling against cross:

```{r}
cross.lm <- lm(price ~ cross, data = gumtreeN)
glance(cross.lm)
```

The p-value is less than the significance level of 0.05, hence the cross data should be considered for the final model.

Modelling against microchipping status:

```{r}
micro.lm <- lm(price ~ micro, data = gumtreeN)
glance(micro.lm)
```

The p-value is greater than the significance level of 0.05, hence the microscipping status data need not be considered for the final model.

Modelling against vaccination:

```{r}
vacc.lm <- lm(price ~ vacc, data = gumtreeN)
glance(vacc.lm)
```

The p-value is greater than the significance level of 0.05, hence the vaccination status data need not be considered for the final model.

Modelling against desexing status:

```{r}
desex.lm <- lm(price ~ desex, data = gumtreeN)
glance(desex.lm)
```

The p-value is less than the significance level of 0.05, hence the desexing status data should be considered for the final model.

Modelling against whether or not the dog is relinquished:

```{r}
relinquished.lm <- lm(price ~ relinquished, data = gumtreeN)
glance(relinquished.lm)
```

The p-value is less than the significance level of 0.05, hence the relinquished data should be considered for the final model.

Modelling against the state in which state the dog is being sold:

```{r}
state.lm <- lm(price ~ state, data = gumtreeN)
glance(state.lm)
```

The p-value is greater than the significance level of 0.05, hence the state data need not be considered for the final model.

### Model Selection

First, we create full and smallest versions of the model to indicate the scope, or rather, the most and least detailed versions of the model:
```{r}

full <-  price ~ (age + cross + micro + vacc + desex + relinquished)^2
smallest <- price ~ 1

```

We also define a version of the gumtree dataset without NA values in order to create our linear model:
```{r}

gumtreeN <- na.omit(gumtree)

```

Next, three different algorithms will be used to determine the model, and the results will be compared in order to decide upon the final model:

First, the backwards selection method is used:

```{r}
options(width = 150)
bM <- lm(full, data = gumtreeN)
bM <- step(bM, direction = "backward")
tidy(bM)
```

Next, the forwards selection method is used:
```{r}
options(width = 150)
fM <- lm(smallest, data = gumtreeN)
fM <- step(fM, scope = full, direction = "forward")
tidy(fM)
```

Finally, the stepwise selection method is used:
```{r}
options(width = 150)
sM <- lm(smallest, data = gumtreeN)
sM <- step(sM, scope = full, direction = "both")
tidy(sM)
```

Here are our 3 models. Notice that they are basically the same model. Age:Cross and Cross:Age interactions terms are essentially the same.  

```{r}
list(backwards = bM,
     forwards = fM,
     step = sM) %>%
  map_df(broom::tidy, .id = "Model") %>%
  select(Model, term, estimate) %>%
  spread(Model, estimate)
```

Let's check our assumptions for this model. We will call it model_1. 

```{r}
model_1<-sM
summary(model_1)
tmp<-par(mfrow=c(2,2))
plot(model_1)
```

Linearity: Check residual vs fitted plot.  If assumption is true we expect the red line to be flat around 0. We see that there is a bit of curvature but it's not too bad. Hence linearity is reasonable. 

Normality: Check normal QQ plot. If assumption is true we expect the points between -2 and 2 to fall on the diagonal line. We see that most points fall on the diagonal although some points curve upward around 2. Normality is ok. 

Equal variance: Check scale location plot. Looking for even spread as we go left to right.Points seem to fan outward as you go from left to right. Equal variance is not reasonable. 

Independence: Plots do not help. Price of dogs should theoretically be independent. 

Notice in the residual vs fitted plot, the points tend to be clustered to the left. This suggests that data is right skewed. Perhaps we can get a better model with a log transform of price. We apply the 3 algorithms we used previously. 



### Logarithm of Price

First, we create bivariate regression models of log(price) against each predictor variable, to decide whether they have enough of an effect on log(price) individually, and if not, they will not be considered for the final model.

Modelling against age:

```{r}
log_age.lm <- lm(log(price) ~ age, data = gumtreeN)
glance(log_age.lm)
```
The p-value is less than the significance level of 0.05, hence the age data should be considered for the final logarithm model.

Modelling against cross:

```{r}
log_cross.lm <- lm(log(price) ~ cross, data = gumtreeN)
glance(log_cross.lm)
```
The p-value is less than the significance level of 0.05, hence the cross data should be considered for the final logarithm model.

Modelling against microchipping status:

```{r}
log_micro.lm <- lm(log(price) ~ micro, data = gumtreeN)
glance(log_micro.lm)
```

The p-value is greater than the significance level of 0.05, hence the microshipping status data need not be considered for the final logarithm model.

Modelling against vaccination:

```{r}
log_vacc.lm <- lm(log(price) ~ vacc, data = gumtreeN)
glance(log_vacc.lm)
```

The p-value is greater than the significance level of 0.05, hence the vaccination status data need not be considered for the final logarithm model.

Modelling against desexing status:

```{r}
log_desex.lm <- lm(log(price) ~ desex, data = gumtreeN)
glance(log_desex.lm)
```

The p-value is less than the significance level of 0.05, hence the desexing status data should be considered for the final logarithm model.

Modelling against whether or not the dog is relinquished:

```{r}
log_relinquished.lm <- lm(log(price) ~ relinquished, data = gumtreeN)
glance(log_relinquished.lm)
```

The p-value is greater than the significance level of 0.05, hence the relinquished data need not be considered for the final logarithm model.

Modelling against the state in which state the dog is being sold:

```{r}
log_state.lm <- lm(log(price) ~ state, data = gumtreeN)
glance(log_state.lm)
```

The p-value is greater than the significance level of 0.05, hence the state data need not be considered for the final logarithm model.


## Logarithm of Price Model Selection

Backward Model:

```{r}
  log_full <-  log(price) ~ (age + cross + micro + vacc + desex + relinquished)^2
  smallest <- log(price) ~ 1
  
  options(width = 150)
  log_bM <- lm(log_full, data = gumtreeN)
  log_bM <- step(log_bM, direction = "backward")
  tidy(log_bM)
```

Forward Model: 
```{r}
 options(width = 150)
  log_fM <- lm(log_full, data = gumtreeN)
  log_fM <- step(log_bM, direction = "forward")
  tidy(log_bM)
```

Stepwise Model:

```{r}
 options(width = 150)
  log_sM <- lm(log_full, data = gumtreeN)
  log_sM <- step(log_bM, direction = "both")
  tidy(log_bM)
```

Let's put the 3 models next to each other. Notice that they are the same. Let's call this model log_model.

```{r}
list(backwards = log_bM,
     forwards = log_fM,
     step = log_sM) %>%
  map_df(broom::tidy, .id = "Model") %>%
  select(Model, term, estimate) %>%
  spread(Model, estimate)
```

Let's check our assumptions. 
```{r}
log_model<-log_sM
summary(log_model)
tmp<-par(mfrow=c(2,2))
plot(log_model)
```


# Prediction
**This is not final as model selection is unfinished, but the code seems to work**
```{r}
predict(bM, data.frame(state = "SA", cross = "yes", age = 1, vacc = "vaccinated",
                       relinquished = "yes", desex = "Desexed",
                       micro = "microchipped"), interval = "predict")
```

We were asked to predict the price of a South Australian, cross-breed dog that is 1 year old. The dog is vaccinated, desexed and unfortunately has to be re-homed because the owner is moving interstate.

Based on our model the price of the dog is $296. 

